function out(e,t){t.end((e.callback||"callback")+"("+JSON.stringify(e)+");")}function saveMsg(e){mtime=e.time=+new Date,list.push({name:e.name,msg:e.msg,time:mtime})}function saveList(){if(mtime===stime);else{stime=mtime;for(var e,t=0;list.length>100;)e=list.splice(0,100),fs.writeFile("data/"+stime+"-"+t++ +".json",JSON.stringify(e,null,4));fs.writeFile("data.json",JSON.stringify(list,null,4))}setTimeout(saveList,12e4)}var fs=require("fs"),http=require("http"),url=require("url"),querystring=require("querystring"),list=JSON.parse(fs.readFileSync("data.json","utf-8")),ctime=+new Date,mtime=ctime,stime=mtime;http.createServer(function(e,t){function i(){m.time!=mtime?(m.msgList=list.filter(function(e){return e.time>m.time}),m.time=mtime,out(m,t)):s>=60?(m.msgList=[],out(m,t)):(s++,setTimeout(i,500))}var s=0,m=querystring.parse(url.parse(e.url).query);if(t.writeHead(200,{"Content-Type":"application/javascript"}),m.name=m.name?m.name.trim():"(匿名)","/favicon.ico"===e.url.toString()){var r=new Date;r.setFullYear(r.getFullYear()+1),t.writeHead(200,{"Content-Type":"image/x-icon",Expires:r}),t.end("")}else m.time&&"POST"!==e.method&&m.method?"push"===m.method?(saveMsg(m),out(m,t)):"exit"===m.method?(m.msg="离开聊天室",saveMsg(m),out(m,t)):i():(m.msg=m.msg||"加入聊天室",m.msgList=[],saveMsg(m),out(m,t))}).listen(8973),saveList();